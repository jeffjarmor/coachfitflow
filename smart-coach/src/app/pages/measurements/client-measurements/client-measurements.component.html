<div class="measurements-container">
    <div class="measurements-header">
        <div>
            <h1>Mediciones de {{ clientName() }}</h1>
            <p>Historial de progreso y resultados</p>
        </div>
        <button class="btn-add" (click)="showForm.set(true)" *ngIf="!showForm()">
            <span class="icon">+</span>
            Nueva MediciÃ³n
        </button>
    </div>

    <!-- Measurement Form -->
    <div class="form-section" *ngIf="showForm()">
        <app-measurement-form [clientId]="clientId()" (onSave)="handleSaveMeasurement($event)"
            (onCancel)="showForm.set(false)" />
    </div>

    <!-- Loading State -->
    <div class="loading-state" *ngIf="loading()">
        <div class="spinner"></div>
        <p>Cargando mediciones...</p>
    </div>

    <!-- Content -->
    <div class="measurements-content" *ngIf="!loading()">
        <!-- Summary Cards -->
        <div class="summary-section" *ngIf="getLatestMeasurement()">
            <div class="summary-card">
                <div class="card-icon weight">ğŸ’ª</div>
                <div class="card-content">
                    <div class="card-label">Peso Actual</div>
                    <div class="card-value">{{ getLatestMeasurement()!.weight }} kg</div>
                    <div class="card-change" *ngIf="getMetricChange('weight')"
                        [class.positive]="getMetricChange('weight')!.isPositive"
                        [class.negative]="!getMetricChange('weight')!.isPositive">
                        <span class="arrow">{{ getMetricChange('weight')!.isPositive ? 'â†“' : 'â†‘' }}</span>
                        {{ getMetricChange('weight')!.value | number:'1.1-1' }} kg
                    </div>
                </div>
            </div>

            <div class="summary-card">
                <div class="card-icon bmi">ğŸ“Š</div>
                <div class="card-content">
                    <div class="card-label">IMC</div>
                    <div class="card-value">{{ getLatestMeasurement()!.bmi | number:'1.1-1' }}</div>
                </div>
            </div>

            <div class="summary-card" *ngIf="getLatestMeasurement()!.bodyFatPercentage">
                <div class="card-icon fat">ğŸ”¥</div>
                <div class="card-content">
                    <div class="card-label">Grasa Corporal</div>
                    <div class="card-value">{{ getLatestMeasurement()!.bodyFatPercentage }}%</div>
                    <div class="card-change" *ngIf="getMetricChange('bodyFatPercentage')"
                        [class.positive]="getMetricChange('bodyFatPercentage')!.isPositive"
                        [class.negative]="!getMetricChange('bodyFatPercentage')!.isPositive">
                        <span class="arrow">{{ getMetricChange('bodyFatPercentage')!.isPositive ? 'â†“' : 'â†‘' }}</span>
                        {{ getMetricChange('bodyFatPercentage')!.value | number:'1.1-1' }}%
                    </div>
                </div>
            </div>

            <div class="summary-card" *ngIf="getLatestMeasurement()!.muscleMass">
                <div class="card-icon muscle">ğŸ’ª</div>
                <div class="card-content">
                    <div class="card-label">Masa Muscular</div>
                    <div class="card-value">{{ getLatestMeasurement()!.muscleMass }} kg</div>
                    <div class="card-change" *ngIf="getMetricChange('muscleMass')"
                        [class.positive]="getMetricChange('muscleMass')!.isPositive"
                        [class.negative]="!getMetricChange('muscleMass')!.isPositive">
                        <span class="arrow">{{ getMetricChange('muscleMass')!.isPositive ? 'â†‘' : 'â†“' }}</span>
                        {{ getMetricChange('muscleMass')!.value | number:'1.1-1' }} kg
                    </div>
                </div>
            </div>
        </div>

        <!-- Chart Section -->
        <div class="chart-section" *ngIf="measurements().length > 1">
            <div class="chart-header">
                <h2>EvoluciÃ³n</h2>
                <div class="metric-selector">
                    <button [class.active]="selectedMetric() === 'weight'" (click)="selectMetric('weight')">
                        Peso
                    </button>
                    <button [class.active]="selectedMetric() === 'bodyFat'" (click)="selectMetric('bodyFat')">
                        % Grasa
                    </button>
                    <button [class.active]="selectedMetric() === 'muscleMass'" (click)="selectMetric('muscleMass')">
                        Masa Muscular
                    </button>
                </div>
            </div>

            <div class="chart-container">
                <div class="chart-bars">
                    <div class="bar-item" *ngFor="let point of getChartData(getMetricKey(selectedMetric()))">
                        <div class="bar-wrapper">
                            <div class="bar"
                                [style.height.%]="(point.value / getMaxValue(getMetricKey(selectedMetric()))) * 100">
                                <span class="bar-value">{{ point.value | number:'1.0-1' }}</span>
                            </div>
                        </div>
                        <div class="bar-label">{{ point.date }}</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Measurements List -->
        <div class="measurements-list">
            <h2>Historial Completo</h2>

            <div class="empty-state" *ngIf="measurements().length === 0">
                <div class="empty-icon">ğŸ“‹</div>
                <p>No hay mediciones registradas</p>
                <button class="btn-primary" (click)="showForm.set(true)">
                    Agregar Primera MediciÃ³n
                </button>
            </div>

            <div class="measurement-item" *ngFor="let measurement of measurements()">
                <div class="measurement-date">
                    <span class="date-day">{{ measurement.date | date:'dd' }}</span>
                    <span class="date-month">{{ measurement.date | date:'MMM yyyy' }}</span>
                </div>

                <div class="measurement-data">
                    <div class="data-row">
                        <span class="data-label">Peso:</span>
                        <span class="data-value">{{ measurement.weight }} kg</span>
                    </div>
                    <div class="data-row">
                        <span class="data-label">IMC:</span>
                        <span class="data-value">{{ measurement.bmi | number:'1.1-1' }}</span>
                    </div>
                    <div class="data-row" *ngIf="measurement.bodyFatPercentage">
                        <span class="data-label">Grasa:</span>
                        <span class="data-value">{{ measurement.bodyFatPercentage }}%</span>
                    </div>
                    <div class="data-row" *ngIf="measurement.muscleMass">
                        <span class="data-label">MÃºsculo:</span>
                        <span class="data-value">{{ measurement.muscleMass }} kg</span>
                    </div>
                    <div class="data-row" *ngIf="measurement.metabolicAge">
                        <span class="data-label">Edad MetabÃ³lica:</span>
                        <span class="data-value">{{ measurement.metabolicAge }} aÃ±os</span>
                    </div>
                    <div class="data-notes" *ngIf="measurement.notes">
                        <strong>Notas:</strong> {{ measurement.notes }}
                    </div>
                </div>

                <button class="btn-delete" (click)="deleteMeasurement(measurement.id!)" title="Eliminar">
                    ğŸ—‘ï¸
                </button>
            </div>
        </div>
    </div>
</div>