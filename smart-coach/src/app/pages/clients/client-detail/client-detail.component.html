<div class="page-container" *ngIf="!loading() && client(); else loadingTemplate">
    <!-- Page Header -->
    <app-page-header [title]="client()?.name || ''" [subtitle]="client()?.email || ''" [backRoute]="'/clients'">
        <div headerActions class="header-actions" data-tutorial="client-actions">
            <app-button [routerLink]="['/clients', client()?.id, 'edit']" variant="outline" class="action-btn">
                <span class="btn-icon">âœï¸</span>
                <span class="btn-text">Editar</span>
            </app-button>
            <app-button [routerLink]="['/competitor/new']" [queryParams]="{ clientId: client()?.id }" variant="outline"
                class="action-btn">
                <span class="btn-icon">ğŸ</span>
                <span class="btn-text desktop-only">Competidor</span>
            </app-button>
            <app-button variant="danger" (click)="showDeleteConfirm.set(true)" class="action-btn">
                <span class="btn-icon">ğŸ—‘ï¸</span>
                <span class="btn-text desktop-only">Eliminar</span>
            </app-button>
        </div>
    </app-page-header>

    <div class="page-content">
        <div class="content-grid">
            <!-- Left Column: Client Info -->
            <div class="info-column">
                <!-- Client Avatar Card (Mobile) -->
                <div class="avatar-card mobile-only">
                    <div class="client-avatar-large">
                        {{ client()?.name?.charAt(0)?.toUpperCase() }}
                    </div>
                </div>

                <!-- Personal Info Card -->
                <div class="info-card">
                    <h3 class="card-title">InformaciÃ³n Personal</h3>
                    <div class="info-grid">
                        <div class="info-item">
                            <span class="info-label">Edad</span>
                            <span class="info-value">{{ calculateAge(client()?.birthDate) }} aÃ±os</span>
                        </div>
                        <div class="info-item" *ngIf="client()?.phone">
                            <span class="info-label">TelÃ©fono</span>
                            <span class="info-value">{{ client()?.phone }}</span>
                        </div>
                        <div class="info-item" *ngIf="client()?.createdAt">
                            <span class="info-label">Se uniÃ³</span>
                            <span class="info-value">{{ client()?.createdAt | date:'d \'de\' MMMM \'de\' y' }}</span>
                        </div>
                    </div>
                </div>

                <!-- Physical Metrics Card -->
                <div class="info-card">
                    <h3 class="card-title">MÃ©tricas FÃ­sicas</h3>
                    <div class="info-grid">
                        <div class="info-item">
                            <span class="info-label">Altura</span>
                            <span class="info-value">{{ client()?.height ? client()?.height + ' cm' : '--' }}</span>
                        </div>
                        <div class="info-item">
                            <span class="info-label">Peso</span>
                            <span class="info-value">{{ client()?.weight ? client()?.weight + ' kg' : '--' }}</span>
                        </div>
                    </div>
                </div>

                <!-- Goal Card -->
                <div class="info-card" *ngIf="client()?.goal">
                    <h3 class="card-title">Objetivo</h3>
                    <p class="goal-text">{{ client()?.goal }}</p>
                </div>
            </div>

            <!-- Right Column: Tabs Content -->
            <div class="content-column">
                <!-- Tabs Navigation -->
                <div class="tabs-container">
                    <div class="tabs-header">
                        <button class="tab-button" [class.active]="activeTab() === 'routines'"
                            (click)="activeTab.set('routines')">
                            ğŸ“‹ Rutinas
                        </button>
                        <button class="tab-button" [class.active]="activeTab() === 'measurements'"
                            (click)="activeTab.set('measurements')">
                            ğŸ“Š Mediciones
                        </button>
                        <button class="tab-button" [class.active]="activeTab() === 'competitor'"
                            (click)="activeTab.set('competitor')">
                            ğŸ Competidor
                        </button>
                    </div>

                    <!-- Tab Content -->
                    <div class="tab-content">
                        <app-routine-list *ngIf="activeTab() === 'routines'" [clientId]="client()!.id!"
                            data-tutorial="routines-section">
                        </app-routine-list>

                        <app-client-measurements *ngIf="activeTab() === 'measurements'" [clientId]="client()!.id!"
                            data-tutorial="measurements-section">
                        </app-client-measurements>

                        <div *ngIf="activeTab() === 'competitor'" class="competitor-container">
                            <!-- Empty State -->
                            <div class="empty-state" *ngIf="competitorSheets().length === 0">
                                <div class="empty-illustration">
                                    <span class="empty-icon">ğŸ†</span>
                                    <div class="empty-circle"></div>
                                </div>
                                <h3>Sin historial de competiciÃ³n</h3>
                                <p>Este atleta aÃºn no tiene hojas de competidor asignadas.</p>
                                <app-button [routerLink]="['/competitor/new']"
                                    [queryParams]="{ clientId: client()?.id }">
                                    Crear primera hoja
                                </app-button>
                            </div>

                            <!-- Competitor Sheets Grid -->
                            <div class="competitor-grid" *ngIf="competitorSheets().length > 0">
                                <div class="competitor-card" *ngFor="let sheet of competitorSheets()">
                                    <div class="card-header">
                                        <div class="header-icon">
                                            <span>ğŸ‹ï¸â€â™‚ï¸</span>
                                        </div>
                                        <div class="header-info">
                                            <h4>{{ sheet.mesocycleTitle }}</h4>
                                            <span class="macro-badge">{{ sheet.macrocycleTitle }}</span>
                                        </div>
                                        <div class="header-actions">
                                            <button class="icon-btn delete-btn"
                                                (click)="showDeleteSheetConfirm.set(sheet.id!)" title="Eliminar hoja">
                                                ğŸ—‘ï¸
                                            </button>
                                        </div>
                                    </div>

                                    <div class="card-body">
                                        <div class="info-row">
                                            <span class="info-icon">ğŸ“…</span>
                                            <span class="info-label">Creado:</span>
                                            <span class="info-value">{{ formatDate(sheet.createdAt) }}</span>
                                        </div>
                                        <div class="info-row">
                                            <span class="info-icon">ğŸ“Š</span>
                                            <span class="info-label">Sesiones:</span>
                                            <span class="info-value">{{ sheet.workouts.length }} entrenamientos</span>
                                        </div>
                                    </div>

                                    <div class="card-footer">
                                        <app-button variant="outline" size="small" [fullWidth]="true"
                                            [routerLink]="['/competitor', sheet.id, 'edit']">
                                            âœï¸ Editar / Ver
                                        </app-button>
                                    </div>
                                </div>
                            </div>

                            <!-- FAB for adding new sheet (mobile only or consistent with app) -->
                            <button class="float-add-btn" [routerLink]="['/competitor/new']"
                                [queryParams]="{ clientId: client()?.id }" *ngIf="competitorSheets().length > 0">
                                +
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<div *ngIf="showDeleteSheetConfirm()" class="modal-overlay" (click)="showDeleteSheetConfirm.set(null)">
    <div class="modal-content" (click)="$event.stopPropagation()">
        <h2>Â¿Eliminar Hoja?</h2>
        <p>Esta acciÃ³n no se puede deshacer.</p>
        <div class="modal-actions">
            <app-button variant="outline" (click)="showDeleteSheetConfirm.set(null)">
                Cancelar
            </app-button>
            <app-button variant="danger" (click)="deleteCompetitorSheet(showDeleteSheetConfirm()!)">
                Eliminar
            </app-button>
        </div>
    </div>
</div>

<!-- Tutorial Help Button -->
<app-tutorial-button (tutorialRequested)="startTutorial()"></app-tutorial-button>

<!-- Loading Template -->
<ng-template #loadingTemplate>
    <div class="loading-container">
        <div class="spinner"></div>
        <p>Cargando informaciÃ³n del cliente...</p>
    </div>
</ng-template>

<!-- Delete Confirmation Modal -->
<div *ngIf="showDeleteConfirm()" class="modal-overlay" (click)="showDeleteConfirm.set(false)">
    <div class="modal-content" (click)="$event.stopPropagation()">
        <h2>Â¿Eliminar Cliente?</h2>
        <p>Esta acciÃ³n no se puede deshacer. Se eliminarÃ¡n todas las rutinas asociadas a este cliente.</p>
        <div class="modal-actions">
            <app-button variant="outline" (click)="showDeleteConfirm.set(false)">
                Cancelar
            </app-button>
            <app-button variant="danger" (click)="deleteClient()">
                Eliminar
            </app-button>
        </div>
    </div>
</div>